# JVM内存管理
## JVM运行时数据区
 JVM运行时的数据区域，可以理解为Java程序在运行时，数据存放的位置。主要分为7个部分（理论模型）：
 
 1. 程序计数器，保存当前程序执行的内存地址（字节码的行号）。用于分支、循环、跳转、异常处理和线程恢复等基础功能；
 2. Java虚拟机栈，线程私有，一个栈包含多个栈帧(Flames)，进入一个方法新建一个栈帧，栈帧包含局部变量表（存储变量值，引用变量记录指向堆的地址）、操作数栈（用于存储操作数，中间结果）、动态链接（运行时多态）、方法出口等信息；
 3.  本地方法栈（native），由本地代码实现，类似于栈；
 4. 直接内存，NIO调用Native函数库直接分配堆外内存，通过DirectByteBuffer对象作为这块内存的引用进行操作。（提高性能避免Java堆和Native堆来回复制数据）。
 5. Java堆，线程共享，垃圾收集器管理的主要区域；
 6. 方法区，各线程共享区域，存储如下内容：
  - 常量池；
  - 静态变量；
  - 域；
  - 方法数据；
  - 方法体；
  - 构造函数；
  - 类中的专用方法；
  - 实例初始化；
  - 接口初始化；
  - **运行时常量池（方法区中）**；

> 方法区的实现(HotSpot)
 JDK1.7，字符串常量池从Perm区移到Java的Heap区域。
- 符号引用被移到了native堆；
- string对象被移到了java堆；
- class对象、静态变量被移到了java堆；
 
> JDK1.8，内存模型变化，移除了Perm区，使用本地内存来存储类元数据信息并称之为：元空间（Metaspace）。
-XX:MetaspaceSize=<NNN>/ -XX:MaxMetaspaceSize=<NNN>/ -XX:MinMetaspaceFreeRatio=<NNN>/ -XX:MaxMetaspaceFreeRatio=<NNN>

## 对象的创建
- new对象； 
- 检查常量区（不存在，则执行类加载），获取类符号引用 ；
- 类加载完成，分配内存：

  单线程内存分配：
  1. 指针碰撞(Bump the Pointer)，用过内存在一边，没用过的在另外一边，内存规整（需要垃圾收集器带由压缩整理功能，Serial、ParNew等带Compact过程的收集器）；
  2. 空闲列表(Free List)，记录空闲内存的列表，内存不规整（CMS，Mark-Sweep）。
  
  多线程内存分配：
  1. CAS + 失败重试，保证更新操作的原子性；
  PS: CAS（compare and swap），乐观锁，比较和替换。CAS(V,E,N)，V表示要更新的变量，E表示预期的值，N表示新值。只有当V的值等于E时，才会将V的值修改为N。如果V的值不等于E，说明已经被其他线程修改了，当前线程可以放弃此操作，也可以再次尝试次操作直至修改成功。
  2. 本地线程分配缓冲（Thread Local Allocation Buffer, TLAB)，预先分配一小块内存，只有当TLAB耗尽时，才使用CAS操作分配内存，-XX:+/-UseTLAB参数。（jdk5及以后的版本默认是启用TLAB的）
 
- 分配完成后，内存空间初始化零值（TLAB，可以再划分时初始化），这样可以不用初始化就使用变量；
- 设置对象头( Object Header）；
- 执行<init>方法；

### 对象内存布局（HotSpot）
对象内存结构分为三个部分：1. 对象头( Object Header )、2. 实例数据( Instance Data )、3. 对齐填充( Padding )。

#### 对象头
对象头包含两部分信息：

1. 自身的运行时数据：
    1. 哈希码；
    2. GC分代年龄；
    3. 锁状态标志；
    4. 线程持有的锁；
    5. 偏向线程ID；
    6. 偏向时间戳等。
    官方：Mark Word，非固定的存储结构。如果对象是数组，需要有一块存储数组长度的信息。
2. 类型指针。（是否存在，具体看实现）

#### 实例数据
数据存储，受虚拟机分配策略参数和字段定义顺序影响。默认分配策略：

1. longs/doubles;
2. ints;
3. shorts/chars;
4. bytes/booleans;
5. oops(Ordinary Object Pointers)。
  
#### 对齐填充
Hotspot VM要求对象起始地址是8字节的整数倍。


### 对象访问
对象的访问方式：
1. 句柄；

在堆中单独划分出一块内存作为句柄池，句柄池中包含对对象实例数据的指针和对象类型数据的指针。
优点：不用修改；缺点：多一次跳转，耗时。

2. 直接指针（Sun HotSpot）；

直接指向对象实例数据，对象实例数据中包含对象类型的指针。
优点：速度快，节省时间开销；缺点：改动频繁。
  



      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                                
  
  
  
  
  
  
